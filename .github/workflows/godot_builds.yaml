name: "Build Godot Engine & Templates"

on:
  workflow_dispatch: # Manual trigger to save GitHub Action minutes
  push:
    tags:
      - 'v*' # Trigger when a version tag is pushed (e.g., v1.0.0)

env:
  # Using a stable version of Godot 4.x
  GODOT_VERSION: "4.5.1-stable"
  # SCons cache location
  SCONS_CACHE: ${{ github.workspace }}/.scons_cache
  SCONS_CACHE_LIMIT: 4096

jobs:
  # --- Job 1: Build Linux Editor and Templates ---
  # We use Ubuntu 22.04 to ensure GLIBC compatibility for most Linux distros
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: "Checkout Godot"
        uses: actions/checkout@v6
        with:
          repository: godotengine/godot
          ref: ${{ env.GODOT_VERSION }}

      - name: "Checkout Voxel Module"
        uses: actions/checkout@v6
        with:
          repository: Zylann/godot_voxel
          ref: 'v1.5x'
          path: modules/voxel

      - name: "Install Linux Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            scons \
            pkg-config \
            libx11-dev \
            libxcursor-dev \
            libxinerama-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libxi-dev \
            libxrandr-dev \
            libwayland-dev \
            libatomic-ops-dev
          clang --version
          ld.lld --version

      - name: "Setup .NET SDK"
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: "SCons Cache"
        uses: actions/cache@v5
        with:
          path: ${{ env.SCONS_CACHE }}
          key: ${{ runner.os }}-godot-${{ env.GODOT_VERSION }}-voxel

      # Build Editor for Development
      - name: "Build Linux Editor"
        run: |
          scons platform=linuxbsd use_llvm=yes linker=lld target=editor module_mono_enabled=yes production=yes lto=thin optimize=speed debug_symbols=no CCFLAGS="-ftrivial-auto-var-init=zero" -j2
          ./bin/godot.linuxbsd.editor.x86_64.mono --headless --generate-mono-glue modules/mono/glue
          python3 modules/mono/build_scripts/build_assemblies.py --godot-output-dir=./bin

      # Build Export Template for Players (Release version)
      - name: "Build Linux Release Template"
        run: |
          scons platform=linuxbsd use_llvm=yes linker=lld target=template_release \
          module_mono_enabled=yes \
          production=yes \
          lto=full \
          optimize=speed \
          CCFLAGS="-march=x86-64-v3 -fno-math-errno -fstack-protector-strong -fstack-clash-protection -fno-common -D_FORTIFY_SOURCE=2 -fno-plt -ftrivial-auto-var-init=zero -ffile-prefix-map=$(pwd)=." \
          LINKFLAGS="-Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack" \
          -j2

      - name: "Package Artifacts"
        run: |
          cd bin
          tar -czvf godot-linux-editor.tar.gz godot.linuxbsd.editor.x86_64.mono GodotSharp/
          zip -j linux-template-release.zip godot.linuxbsd.template_release.x86_64.mono

      - name: "Upload Linux Build"
        uses: actions/upload-artifact@v6
        with:
          name: linux-builds
          path: bin/*.tar.gz

      - name: "Upload Linux Templates"
        uses: actions/upload-artifact@v6
        with:
          name: linux-templates
          path: bin/*.zip
